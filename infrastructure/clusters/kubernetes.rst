.. _k8s:

Kubernetes Clusters
-------------------

Requirements
^^^^^^^^^^^^

- Agent installation is required for Master and Worker Nodes. Refer to :ref:`Morpheus Agent` section for additional information.
- Access to Cloud Front, Image copy access and permissions for System and Uploaded Images used in Cluster Layouts
   Image(s) used in Cluster Layouts must either exist in destination cloud/resource or be able to be copied to destination by Morpheus, typically applicable for non-public clouds. For the initial provision, Morpheus System Images are streamed from Cloud Front through Morpheus to target destination. Subsequent provisions clone the local Image.
- System Kubernetes Layouts require Master and Worker nodes to access to the following over 443 during K8s install and configuration:

  * Morpheus Appliance url (443)
  * https://packages.cloud.google.com
  * https://storage.googleapis.com
  * https://docs.projectcalico.org
  * https://openebs.github.io
  * https://cloud.weave.works

- Morpheus Role permission ``Infrastructure: Clusters > Full`` required for Viewing, Creating, Editing and Deleting Clusters.
- Morpheus Role permission ``Infrastructure: Clusters > Read`` required for Viewing Cluster list and detail pages.

Creating Kubernetes Clusters
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Provisions a new Kubernetes Cluster in selected target Cloud using selected Layout.

System (|morpheus| provided) Kubernetes Layouts at time of |morphver| release. Note: AKS & GKE Kubernetes versions will dynamically update to the providers supported versions.


+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| NAME                                                       | DESCRIPTION                                                                          | CODE                                                       | SERVER COUNT | COMPUTE VER | CLUSTER VER | STORAGE RUNTIME | NETWORK RUNTIME | CONTAINER RUNTIME |
+============================================================+======================================================================================+============================================================+==============+=============+=============+=================+=================+===================+
| External Kubernetes 1.20                                   | Connect to an external kubernetes cluster                                            | kubernetes-external-1.20                                   | 1            | n/a         | 1.20.2      | n/a             | n/a             | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| External Kubernetes 1.21                                   | Connect to an external kubernetes cluster                                            | kubernetes-external-1.21                                   | 1            | n/a         | 1.21.3      | n/a             | n/a             | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| External Kubernetes 1.22                                   | Connect to an external kubernetes cluster                                            | kubernetes-external-1.22                                   | 1            | n/a         | 1.22.3      | n/a             | n/a             | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| External Kubernetes 1.23                                   | Connect to an external kubernetes cluster.                                           | kubernetes-external-1.23                                   | 1            | n/a         | 1.23.5      | n/a             | n/a             | n/a               |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| Kubernetes 1.14 Cluster on Ubuntu 16.04, Weave, OpenEBS    | This will provision a single kubernetes master in fusion with weave and openebs      | kubernetes-fusion-ubuntu-16.04-single                      | 4            | 16.04       | n/a         | n/a             | n/a             | n/a               |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| Kubernetes 1.14 HA Cluster on Ubuntu 16.04, Weave, OpenEBS | This will provision a single kubernetes master in fusion with weave and openebs      | kubernetes-fusion-ubuntu-16.04-cluster-weave-openebs       | 6            | 16.04       | n/a         | n/a             | n/a             | n/a               |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| Kubernetes 1.15 Cluster on Ubuntu 18.04, Weave, OpenEBS    | This will provision a single kubernetes master in fusion with weave and openebs      | kubernetes-1.15-fusion-ubuntu-18.04-single                 | 4            | 18.04       | n/a         | n/a             | n/a             | n/a               |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| Kubernetes 1.16 Cluster on Ubuntu 18.04, Weave, OpenEBS    | This will provision a single kubernetes master in fusion with weave and openebs      | kubernetes-1.16-fusion-ubuntu-18.04-single                 | 4            | 18.04       | n/a         | n/a             | n/a             | n/a               |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| Kubernetes 1.17 Cluster on Ubuntu 18.04, Weave, OpenEBS    | This will provision a single kubernetes master in fusion with weave and openebs      | kubernetes-1.17-fusion-ubuntu-18.04-single                 | 4            | 18.04       | n/a         | n/a             | n/a             | n/a               |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| Kubernetes 1.21 Cluster EKS                                | This will provision a single kubernetes master in amazon with weave and openebs      | kubernetes-amazon-eks-1.21                                 | 2            | 1.21        | 1.21        | n/a             | n/a             | n/a               |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| Kubernetes 1.21.7 Cluster AKS                              | This provisions a single kubernetes master in Azure                                  | kubernetes-azure-aks-1.21.7                                | 2            | 1.21.7      | 1.21.7      | n/a             | n/a             | n/a               |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| Kubernetes 1.21.9 Cluster AKS                              | This provisions a single kubernetes master in Azure                                  | kubernetes-azure-aks-1.21.9                                | 2            | 1.21.9      | 1.21.9      | n/a             | n/a             | n/a               |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| Kubernetes 1.22 Cluster EKS                                | This will provision a single kubernetes master in amazon with weave and openebs      | kubernetes-amazon-eks-1.22                                 | 2            | 1.22        | 1.22        | n/a             | n/a             | n/a               |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| Kubernetes 1.22.4 Cluster AKS                              | This provisions a single kubernetes master in Azure                                  | kubernetes-azure-aks-1.22.4                                | 2            | 1.22.4      | 1.22.4      | n/a             | n/a             | n/a               |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| Kubernetes 1.22.6 Cluster AKS                              | This provisions a single kubernetes master in Azure                                  | kubernetes-azure-aks-1.22.6                                | 2            | 1.22.6      | 1.22.6      | n/a             | n/a             | n/a               |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| Kubernetes 1.23.3 Cluster AKS                              | This provisions a single kubernetes master in Azure                                  | kubernetes-azure-aks-1.23.3                                | 2            | 1.23.3      | 1.23.3      | n/a             | n/a             | n/a               |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| Kubernetes 1.23.5 Cluster AKS                              | This provisions a single kubernetes master in Azure                                  | kubernetes-azure-aks-1.23.5                                | 2            | 1.23.5      | 1.23.5      | n/a             | n/a             | n/a               |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| Kubernetes Cluster GKE                                     | This will provision a single kubernetes master in google                             | kubernetes-google-gke                                      | 2            | n/a         |             | n/a             | n/a             | n/a               |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.20 Cluster on Ubuntu 18.04                | provision a kubernetes 1.20 cluster on ubuntu 18.04 in vCloud Director               | kubernetes-1.20.2-ubuntu-18.04.5-vcd-amd64-single          | 4            | 18.04       | 1.20.2      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.20 Cluster on Ubuntu 18.04                | provision a kubernetes 1.20 cluster on ubuntu 18.04 in fusion                        | kubernetes-1.20.2-ubuntu-18.04.5-fusion-amd64-single       | 4            | 18.04       | n/a         | rook            | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.20 Cluster on Ubuntu 18.04                | provision a kubernetes 1.20 cluster on ubuntu 18.04 in vmware                        | kubernetes-1.20.2-ubuntu-18.04.5-vmware-amd64-single       | 4            | 16.04       | 1.20.2      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.20 Cluster on Ubuntu 18.04                | provision a kubernetes 1.20 cluster on ubuntu 18.04                                  | kubernetes-1.20.2-ubuntu-18.04.5-amazon-amd64-single       | 4            | 16.04       | 1.20.2      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.20 Cluster on Ubuntu 18.04                | provision a kubernetes 1.20 cluster on ubuntu 18.04                                  | kubernetes-1.20.2-ubuntu-18.04.5-google-amd64-single       | 4            | 16.04       | 1.20.2      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.20 Cluster on Ubuntu 18.04                | provision a kubernetes 1.20 cluster on ubuntu 18.04 in Openstack                     | kubernetes-1.20.2-ubuntu-18.04.5-openstack-amd64-single    | 4            | 16.04       | 1.20.2      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.20 Cluster on Ubuntu 18.04                | provision a kubernetes 1.20 cluster on ubuntu 18.04 in hyperv                        | kubernetes-1.20.2-ubuntu-18.04.5-hyperv-amd64-single       | 4            | 16.04       | 1.20.2      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.20 Cluster on Ubuntu 18.04                | provision a kubernetes 1.20 cluster on ubuntu 18.04 in manual                        | kubernetes-1.20.2-ubuntu-18.04.5-morpheus-amd64-single     | 4            | 18.04       | n/a         | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.20 Cluster on Ubuntu 18.04                | provision a kubernetes 1.20 cluster on ubuntu 18.04                                  | kubernetes-1.20.2-ubuntu-18.04.5-nutanix-amd64-single      | 4            | 16.04       | 1.20.2      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.20 Cluster on Ubuntu 18.04                | provision a kubernetes 1.20 cluster on ubuntu 18.04 in opentelekom                   | kubernetes-1.20.2-ubuntu-18.04.5-opentelekom-amd64-single  | 4            | 16.04       | 1.20.2      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.20 Cluster on Ubuntu 18.04                | provision a kubernetes 1.20 cluster on ubuntu 18.04 in scvmm                         | kubernetes-1.20.2-ubuntu-18.04.5-scvmm-amd64-single        | 4            | 16.04       | 1.20.2      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.20 Cluster on Ubuntu 18.04                | provision a kubernetes 1.20 cluster on ubuntu 18.04 in Huawei                        | kubernetes-1.20.2-ubuntu-18.04.5-huawei-amd64-single       | 4            | 16.04       | 1.20.2      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.20 Cluster on Ubuntu 20.04                | provision a kubernetes 1.20 cluster on ubuntu 18.04 in xen                           | kubernetes-1.20.2-ubuntu-18.04.5-xen-amd64-single          | 4            | 16.04       | 1.20.2      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.20 HA Cluster on Ubuntu 18.04             | provision a high availability kubernetes 1.20 cluster on ubuntu 18.04                | kubernetes-1.20.2-ubuntu-18.04.5-google-amd64              | 6            | 16.04       | 1.20.2      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.20 HA Cluster on Ubuntu 18.04             | provision a high availability kubernetes 1.20 cluster on ubuntu 18.04 in vmware      | kubernetes-1.20.2-ubuntu-18.04.5-vmware-amd64              | 6            | 16.04       | 1.20.2      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.20 HA Cluster on Ubuntu 18.04             | provision a high availability kubernetes 1.20 cluster on ubuntu 18.04                | kubernetes-1.20.2-ubuntu-18.04.5-nutanix-amd64             | 6            | 16.04       | 1.20.2      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.20 HA Cluster on Ubuntu 18.04             | provision a high availability kubernetes 1.20 cluster on ubuntu 18.04 in Openstack   | kubernetes-1.20.2-ubuntu-18.04.5-openstack-amd64           | 6            | 16.04       | 1.20.2      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.20 HA Cluster on Ubuntu 18.04             | provision a high availability kubernetes 1.20 cluster on ubuntu 18.04 in hyperv      | kubernetes-1.20.2-ubuntu-18.04.5-hyperv-amd64              | 6            | 16.04       | 1.20.2      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.20 HA Cluster on Ubuntu 18.04             | provision a high availability kubernetes 1.20 cluster on ubuntu 18.04 in manual      | kubernetes-1.20.2-ubuntu-18.04.5-morpheus-amd64            | 6            | 18.04       | n/a         | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.20 HA Cluster on Ubuntu 18.04             | provision a high availability kubernetes 1.20 cluster on ubuntu 18.04 in opentelekom | kubernetes-1.20.2-ubuntu-18.04.5-opentelekom-amd64         | 6            | 16.04       | 1.20.2      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.20 HA Cluster on Ubuntu 18.04             | provision a high availability kubernetes 1.20 cluster on ubuntu 18.04                | kubernetes-1.20.2-ubuntu-18.04.5-amazon-amd64              | 6            | 16.04       | n/a         | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.20 HA Cluster on Ubuntu 20.04             | provision a high availability kubernetes 1.20 cluster on ubuntu 18.04 in xen         | kubernetes-1.20.2-ubuntu-18.04.5-xen-amd64                 | 6            | 16.04       | 1.20.2      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.21 Cluster on Ubuntu 20.04                | provision a kubernetes 1.21 cluster on ubuntu 20.04 in fusion                        | kubernetes-1.21.3-ubuntu-20.04.1-fusion-amd64-single       | 4            | 20.04       | 1.21.3      | rook            | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.21 Cluster on Ubuntu 20.04                | provision a kubernetes 1.21 cluster on ubuntu 20.04 in vmware                        | kubernetes-1.21.3-ubuntu-20.04.1-vmware-amd64-single       | 4            | 20.04       | 1.21.3      | rook            | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.21 Cluster on Ubuntu 20.04                | provision a Kubernetes 1.21 Cluster on Ubuntu 20.04                                  | kubernetes-1.21.3-ubuntu-20.04.1-amazon-amd64-single       | 4            | 20.04       | 1.21.3      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.21 Cluster on Ubuntu 20.04                | provision a kubernetes 1.21 cluster on ubuntu 20.04                                  | kubernetes-1.21.3-ubuntu-20.04.1-digitalocean-amd64-single | 4            | 20.04       | n/a         | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.21 Cluster on Ubuntu 20.04                | provision a Kubernetes 1.21 cluster on Ubuntu 20.04                                  | kubernetes-1.21.3-ubuntu-20.04.1-google-amd64-single       | 4            | 16.04       | n/a         | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.21 Cluster on Ubuntu 20.04                | provision a Kubernetes 1.21 cluster on Ubuntu 20.04 in Huawei                        | kubernetes-1.21.3-ubuntu-20.04.1-huawei-amd64-single       | 4            | 20.04       | n/a         | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.21 Cluster on Ubuntu 20.04                | provision a Kubernetes 1.21 cluster on Ubuntu 20.04 in manual                        | kubernetes-1.21.3-ubuntu-20.04.1-morpheus-amd64-single     | 4            | 20.04       | n/a         | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.21 Cluster on ubuntu 20.04                | provision a kubernetes 1.21 cluster on ubuntu 20.04 in opentelekom                   | kubernetes-1.21.3-ubuntu-20.04.1-opentelekom-amd64-single  | 4            | 20.04       | n/a         | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.21 Cluster on Ubuntu 20.04                | provision a Kubernetes 1.21 cluster on Ubuntu 20.04 in Openstack                     | kubernetes-1.21.3-ubuntu-20.04.1-openstack-amd64-single    | 4            | 20.04       | n/a         | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.21 Cluster on Ubuntu 20.04                | provision a kubernetes 1.21 cluster on ubuntu 20.04 in scvmm                         | kubernetes-1.21.3-ubuntu-20.04.1-scvmm-amd64-single        | 4            | 20.04       | n/a         | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.21 Cluster on Ubuntu 20.04                | provision a Kubernetes 1.21 cluster on Ubuntu 20.04 in vCloud Director               | kubernetes-1.21.3-ubuntu-20.04.1-vcd-amd64-single          | 4            | 20.04       | 1.21.3      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.21 Cluster on Ubuntu 20.04                | provision a Kubernetes 1.21 cluster on Ubuntu 20.04 in xen                           | kubernetes-1.21.3-ubuntu-20.04.1-xen-amd64-single          | 4            | 20.04       | n/a         | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.22 Cluster on Ubuntu 20.04                | provision a kubernetes 1.22 cluster on ubuntu 20.04 in fusion                        | kubernetes-1.22.3-ubuntu-20.04.1-fusion-amd64-single       | 4            | 20.04       | 1.22.3      | rook            | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.22 Cluster on Ubuntu 20.04                | provision a kubernetes 1.22 cluster on ubuntu 20.04 in vmware                        | kubernetes-1.22.3-ubuntu-20.04.1-vmware-amd64-single       | 4            | 20.04       | 1.22.3      | rook            | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.22 Cluster on Ubuntu 20.04                | provision a Kubernetes 1.22 Cluster on Ubuntu 20.04                                  | Kubernetes 1.22.3-ubuntu-20.04.1-amazon-amd64-single       | 4            | 20.04       | 1.22.3      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.22 Cluster on Ubuntu 20.04                | provision a kubernetes 1.22 cluster on ubuntu 20.04                                  | kubernetes-1.22.3-ubuntu-20.04.1-digitalocean-amd64-single | 4            | 20.04       | n/a         | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.22 Cluster on Ubuntu 20.04                | provision a Kubernetes 1.22 cluster on Ubuntu 20.04                                  | kubernetes-1.22.3-ubuntu-20.04.1-google-amd64-single       | 4            | 16.04       | n/a         | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.22 Cluster on Ubuntu 20.04                | provision a Kubernetes 1.22 cluster on Ubuntu 20.04 in hyperv                        | kubernetes-1.22.3-ubuntu-20.04.1-hyperv-amd64-single       | 4            | 20.04       | n/a         | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.22 Cluster on Ubuntu 20.04                | provision a Kubernetes 1.22 cluster on Ubuntu 20.04 in manual                        | kubernetes-1.22.3-ubuntu-20.04.1-morpheus-amd64-single     | 4            | 20.04       | n/a         | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.22 Cluster on Ubuntu 20.04                | provision a kubernetes 1.22 cluster on ubuntu 20.04 in scvmm                         | kubernetes-1.22.3-ubuntu-20.04.1-scvmm-amd64-single        | 4            | 20.04       | n/a         | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.22 Cluster on Ubuntu 20.04                | provision a Kubernetes 1.22 cluster on Ubuntu 20.04 in vCloud Director               | kubernetes-1.22.3-ubuntu-20.04.1-vcd-amd64-single          | 4            | 20.04       | 1.22.3      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.22 Cluster on Ubuntu 20.04                | provision a Kubernetes 1.22 cluster on Ubuntu 20.04 in xen                           | kubernetes-1.22.3-ubuntu-20.04.1-xen-amd64-single          | 4            | 20.04       | n/a         | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.23 Cluster on Ubuntu 20.04                | provision a kubernetes 1.23 cluster on ubuntu 20.04 in vmware                        | kubernetes-1.23.5-ubuntu-20.04.1-vmware-amd64-single       | 4            | 20.04       | 1.23.5      | rook            | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.23 Cluster on Ubuntu 20.04                | provision a Kubernetes 1.23 cluster on Ubuntu 20.04                                  | kubernetes-1.23.5-ubuntu-20.04.1-nutanix-amd64-single      | 4            | 20.04       | 1.23.5      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.23 Cluster on Ubuntu 20.04                | provision a Kubernetes 1.23 Cluster on Ubuntu 20.04                                  | Kubernetes 1.23.5-ubuntu-20.04-amazon-amd64-single         | 4            | 20.04       | 1.23.5      | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.23 Cluster on Ubuntu 20.04                | provision a kubernetes 1.23 cluster on ubuntu 20.04                                  | kubernetes-1.23.5-ubuntu-20.04-digitalocean-amd64-single   | 4            | 20.04       | n/a         | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.23 Cluster on Ubuntu 20.04                | provision a kubernetes 1.23 cluster on ubuntu 20.04 in fusion                        | kubernetes-1.23.5-ubuntu-20.04-fusion-amd64-single         | 4            | 20.04       | 1.23.5      | rook            | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.23 Cluster on Ubuntu 20.04                | provision a Kubernetes 1.23 cluster on Ubuntu 20.04 in manual                        | kubernetes-1.23.5-ubuntu-20.04-morpheus-amd64-single       | 4            | 20.04       | n/a         | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+
| MKS Kubernetes 1.23 Cluster on Ubuntu 20.04                | provision a Kubernetes 1.23 cluster on Ubuntu 20.04 in xen                           | kubernetes-1.23.5-ubuntu-20.04-xen-amd64-single            | 4            | 20.04       | n/a         | n/a             | calico          | containerd        |
+------------------------------------------------------------+--------------------------------------------------------------------------------------+------------------------------------------------------------+--------------+-------------+-------------+-----------------+-----------------+-------------------+



|


To create a new Kubernetes Cluster:

#. Navigate to ``Infrastructure > Clusters``
#. Select :guilabel:`+ ADD CLUSTER`
#. Select ``Kubernetes Cluster``
#. Select a Group for the Cluster
#. Select :guilabel:`NEXT`
#. Populate the following:

   CLOUD
    Select target Cloud
   CLUSTER NAME
    Name for the Kubernetes Cluster
   RESOURCE NAME
    Name for Kubernetes Cluster resources
   DESCRIPTION
    Description of the Cluster
   VISIBILITY
    Public
      Available to all Tenants
    Private
      Available to Master Tenant
   LABELS
    Internal label(s)

#. Select :guilabel:`NEXT`
#. Populate the following:

   .. note:: VMware sample fields provided. Actual options depend on Target Cloud

   LAYOUT
    Select from available layouts. System provided layouts include Single Master and Cluster Layouts.
   PLAN
    Select plan for Kubernetes Master
   VOLUMES
    Configure volumes for Kubernetes Master
   NETWORKS
    Select the network for Kubernetes Master & Worker VM's
   CUSTOM CONFIG
    Add custom Kubernetes annotations and config hash
   CLUSTER HOSTNAME
    Cluster address Hostname (cluster layouts only)
   POD CIDR
    POD network range in CIDR format ie 192.168.0.0/24 (cluster layouts only)
   WORKER PLAN
    Plan for Worker Nodes (cluster layouts only)
   NUMBER OF WORKERS
    Specify the number of workers to provision
   LOAD BALANCER
    Select an available Load Balancer (cluster layouts only) }
   User Config
     CREATE YOUR USER
       Select to create your user on provisioned hosts (requires Linux user config in |morpheus| User Profile)
     USER GROUP
       Select User group to create users for all User Group members on provisioned hosts (requires Linux user config in |morpheus| User Profile for all members of User Group)
   Advanced Options
    DOMAIN
      Specify Domain override for DNS records
    HOSTNAME
      Set hostname override (defaults to Instance name unless an Active Hostname Policy applies)

#. Select :guilabel:`NEXT`
#. Select optional Workflow to execute
#. Select :guilabel:`NEXT`
#. Review and select :guilabel:`COMPLETE`

   - The Master Node(s) will provision first.
   - Upon successful completion of VM provision, Kubernetes scripts will be executed to install and configure Kubernetes on the Masters.
       .. note:: Access to the sites listed in the :ref:`Requirements` section is required from Master and Worker nodes over 443
   - After Master or Masters are successfully provisioned and Kubernetes is successfully installed and configured, the Worker Nodes will provision in parallel.
   - Provision status can be viewed:
      - From the Status next to the Cluster in ``Infrastructure > Clusters``
      - Status bar with eta and current step available on Cluster detail page, accessible by selecting the Cluster name from ``Infrastructure > Clusters``
   - All process status and history is available
     - From the Cluster detail page History tab, accessible by selecting the Cluster name from ``Infrastructure > Clusters`` and the History tab
     - From `Operations - Activity - History`
     - Individual process output available by clicking `i` on target process

#. Once all Master and Worker Nodes are successfully provisioned and Kubernetes is installed and configured, the Cluster status will turn green.

    .. IMPORTANT:: Cluster provisioning requires successful creation of VMs, Agent Installation, and execution of Kubernetes workflows. Consult process output from ````Infrastructure > Clusters - Details`` and morpheus-ui current logs at ``Administration - Health - Morpheus Logs`` for information on failed Clusters.

Intra-Kubernetes Cluster Port Requirements
``````````````````````````````````````````

The table below includes port requirements for the machines within the cluster (not for the |morpheus| appliance itself). Check that the following ports are open on Control-plane and Worker nodes:

.. list-table:: **Control-plane node(s)**
  :widths: auto
  :header-rows: 1

  * - Protocol
    - Direction
    - Port Range
    - Purpose
    - Used By
  * - TCP
    - Inbound
    - 6443
    - Kubernetes API Server
    - All
  * - TCP
    - Inbound
    - 6783
    - Weaveworks
    -
  * - TCP
    - Inbound
    - 2379-2380
    - etcd server client API
    - kube-apiserver, etcd
  * - TCP
    - Inbound
    - 10250
    - kubelet API
    - Self, Control plane
  * - TCP
    - Inbound
    - 10251
    - kube-scheduler
    - Self
  * - TCP
    - Inbound
    - 10252
    - kube-controller-manager
    - Self

.. list-table:: **Worker node(s)**
  :widths: auto
  :header-rows: 1

  * - Protocol
    - Direction
    - Port Range
    - Purpose
    - Used By
  * - TCP
    - Inbound
    - 10250
    - kubelet API
    - Self, Control plane
  * - TCP
    - Inbound
    - 30000-32767
    - NodePort Services
    - All

Adding Worker Nodes
^^^^^^^^^^^^^^^^^^^

#. Navigate to ``Infrastructure - Clusters``
#. Select ``v MORE`` for the target cluster
#. Select ``ADD (type) Kubernetes Worker``

   NAME
      Name of the Worker Node. Auto=populated with ``${cluster.resourceName}-worker-${seq}``
   DESCRIPTION
      Description of the Worker Node, displayed in Worker tab on Cluster Detail pages, and on Worker Host Detail page
   CLOUD
      Target Cloud for the Worker Node.

#. Select :guilabel:`NEXT`
#. Populate the following:

   .. note:: VMware sample fields provided. Actual options depend on Target Cloud

   SERVICE PLAN
    Service Plan for the new Worker Node
   NETWORK
    Configure network options for the Worker node.
   HOST
    If Host selection is enabled, optionally specify target host for new Worker node
   FOLDER
    Optionally specify target folder for new Worker node
      Advanced Options
       DOMAIN
         Specify Domain override for DNS records
       HOSTNAME
         Set hostname override (defaults to Instance name unless an Active Hostname Policy applies)

#. Select :guilabel:`NEXT`
#. Select optional Workflow to execute
#. Select :guilabel:`NEXT`
#. Review and select :guilabel:`COMPLETE`

.. note:: Ensure there is a default StorageClass available when using a Morpheus Kubernetes cluster with OpenEBS so that Kubernetes specs or HELM templates that use a default StorageClass for Persistent Volume Claims can be utilised.

Kubernetes Cluster Detail Pages
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The Kubernetes Cluster Detail page provides a high degree of monitoring and control over Kubernetes Clusters. This includes monitoring of all nodes in the Cluster, ``kubectl`` command line, account and role control, workload management, and more. The upper section of the page (which is persistent regardless of the currently-selected tab) provides high level costing and monitoring information, including a current aggregate metric for the CPU, memory and storage use.

.. image:: /images/infrastructure/clusters/kubernetes/clusterDetail.png

The upper section also includes the ACTIONS menu which includes the following functions:

- **REFRESH:** Forces a routine sync of the cluster status
- **PERMISSIONS:** View and edit the Group, Service Plan, and Tenant access permissions for the cluster
- **VIEW API TOKEN:** Displays the API token for the cluster
- **VIEW KUBE CONFIG:** Displays the cluster configuration
- **RUN WORKLOAD:** Run deployments, stateful sets, daemon sets, or jobs and target them to a specific namespace
- **UPGRADE CLUSTER:** Upgrade the cluster to a higher version of Kubernetes
- **ADD KUBERNETES WORKER:** Launches a wizard which allows users to configure a new worker for the cluster

Additional monitoring and control panes are located within tabs, some of which contain subtabs.

.. tabs::

    .. tab:: Summary

       The summary tab contains high-level details on health and makeup of the cluster.

       .. image:: /images/infrastructure/clusters/kubernetes/clusterSummary.png

    .. tab:: Control

        Contains the ``kubectl`` command line with ability to target commands to specific namespaces. The Control tab also contains the Packages subtab which displays the list of packages and their versions.

        .. image:: /images/infrastructure/clusters/kubernetes/clusterControl.png

    .. tab:: Access

        The Access Tab contains view and edit tools for Namespaces, accounts, roles, and role bindings.

        .. image:: /images/infrastructure/clusters/kubernetes/clusterAccess.png

    .. tab:: Nodes

        The nodes tab includes a list of master and worker nodes in the cluster, their statuses, and the current compute, memory, and storage pressure on each node.

        .. image:: /images/infrastructure/clusters/kubernetes/clusterNodes.png

    .. tab:: Workloads

        View and edit existing Pods, Deployments, Replica Sets, Daemon Sets, Stateful Sets, and Jobs. Add new Deployments, Stateful Sets, Daemon Sets, and Jobs through the ACTIONS menu near the top of the Cluster Detail Page.

        .. image:: /images/infrastructure/clusters/kubernetes/clusterWorkloads.png

    .. tab:: Network

        View, add, and edit Services, Endpoints, Ingress and Network Policies

        .. image:: /images/infrastructure/clusters/kubernetes/clusterNetwork.png

    .. tab:: Storage

        View, add, and edit Storage classes, Volume claims, Volumes, Config maps, and Secrets

        .. image:: /images/infrastructure/clusters/kubernetes/clusterStorage.png

    .. tab:: Containers

        View a list of containers running on the cluster and restart or delete them if needed. This list can be filtered by Namespace or a specific Worker if desired.

        .. image:: /images/infrastructure/clusters/kubernetes/clusterContainers.png

    .. tab:: Monitoring

        View logs and events with filtering tools and search functionality available.

        .. image:: /images/infrastructure/clusters/kubernetes/clusterMonitoring.png

    .. tab:: History

        View the Cluster lifecycle history. This includes lists of automation packages (Tasks and Workflows) run against the cluster or its nodes, the success of these scripts and the output.

        .. image:: /images/infrastructure/clusters/kubernetes/clusterHistory.png

    .. tab:: Wiki

        View the |morpheus| Wiki entry for this Cluster. This Wiki page may also be viewed in the Wiki section (|OpeWik|). Edit the Wiki as desired, most standard Markdown syntax will be honored allowing the use of headings, links, embedded images, and more.

        .. image:: /images/infrastructure/clusters/kubernetes/clusterWiki.png

Adding External Kubernetes Clusters
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

|morpheus| supports the management and consumption of Kubernetes clusters provisioned outside of |morpheus|. These are referred to as External Kubernetes Clusters in |morpheus| UI. This could be used, for example, to onboard and manage OpenShift clusters. In order to fully integrate the Kubernetes cluster with the |morpheus| feature set, you may need to create a service account for |morpheus|. Without first taking that step, some features may not work fully, such as listing all namespaces. The process for creating a service account and integrating the Cluster with |morpheus| is described here.

First, create the Service Account within the Kubernetes cluster:

.. code-block:: bash

  kubectl create serviceaccount morpheus

Next, create the Role Binding:

.. code-block:: bash

  kubectl create clusterrolebinding morpheus-admin \
  --clusterrole=cluster-admin --serviceaccount=default:morpheus \
  --namespace=default

With those items created, we can gather the API URL and the API token which will be used to add the existing cluster to |morpheus| in the next step:

.. code-block:: bash

  kubectl config view --minify | grep server | cut -f 2- -d ":" | tr -d " "

.. code-block:: bash

  SECRET_NAME=$(kubectl get secrets | grep ^morpheus | cut -f1 -d ' ')
  kubectl describe secret $SECRET_NAME | grep -E '^token' | cut -f2 -d':' | tr -d " "

After finishing those steps, we can now create the external cluster in |morpheus|. Navigate to |InfClu|. Click :guilabel:`+ ADD CLUSTER` and then select "External Kubernetes Cluster". Set the following fields, you will have to advance through the pages of the wizard to see all fields indicated:

- **GROUP:** A previously created |morpheus| Group
- **CLOUD:** A previously-integrated Cloud
- **CLUSTER NAME:** A friendly name for the onboarded cluster in |morpheus| UI
- **RESOURCE NAME:** The resource name will be pre-pended to Kubernetes hosts associated with this cluster when shown in |morpheus| UI
- **LAYOUT:** Set an associated Layout
- **API URL:** Enter the API URL gathered in the previous step
- **API TOKEN:** Enter the API Token gathered in the previous step
- **KUBE CONFIG:** Enter Kubeconfig YAML to authenticate the cluster

The above are the required fields, others may be optionally configured depending on the situation. Complete the wizard and |morpheus| will begin the process of onboarding the existing cluster into management within |morpheus| UI. Once things are finalized and statuses are green, the cluster can be monitored and consumed as any other cluster provisioned from |morpheus|.

.. image:: /images/infrastructure/clusters/extKube.png
